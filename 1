#include <Servo.h>
Servo myservo;

// ===== Pins =====
const int Trig = 12;
const int Echo = 13;

#define ENA  5
#define ENB  6
#define IN1  3
#define IN2  4
#define IN3  2
#define IN4  7

// ===== ุฅุนุฏุงุฏุงุช ุงูุญุฑูุฉ =====
int carSpeed     = 140;    // ุณุฑุนุฉ ุงูุฑูุจูุช
int centerAngle  = 100;    // ุฒุงููุฉ ุงููุณุท (100 = ุชูุฑูุจูุง ููุฃูุงู)
int rightAngle   = 20;     // ูููู
int leftAngle    = 160;    // ูุณุงุฑ

// ===== ุฅุนุฏุงุฏุงุช ุงูุชุชุจูุน =====
int minFollowCM  = 30;     // ุฃูุฑุจ ูุณุงูุฉ ููุชุชุจุน
int maxFollowCM  = 50;     // ุฃุจุนุฏ ูุณุงูุฉ ููุชุชุจุน
int backLimitCM  = 10;     // ูู ุฃูุฑุจ ูู ููู โ ุฑุฌูุน
int farLimitCM   = 150;    // ุจุนุฏ ูุงููุฏู โ ุจุญุซ ุจุณูุท

// ===== ุฅุนุฏุงุฏุงุช ุงูุชุฃุฎูุฑ =====
int scanDelayMs  = 250;
int turnMs       = 250;
int fwdMs        = 250;
int backMs       = 250;

// ===== ุฏูุงู ุงููุญุฑูุงุช (ุงุชุฌุงูุงุช ูุตุญูุญุฉ ุญุณุจ ุญุงูุชู ุงูุณุงุจูุฉ) =====
void stopAll(){
  analogWrite(ENA, 0);
  analogWrite(ENB, 0);
  digitalWrite(IN1,LOW); digitalWrite(IN2,LOW);
  digitalWrite(IN3,LOW); digitalWrite(IN4,LOW);
}

void forward(){
  analogWrite(ENA, carSpeed);
  analogWrite(ENB, carSpeed);
  digitalWrite(IN1, LOW);  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW);  digitalWrite(IN4, HIGH);
}

void back(){
  analogWrite(ENA, carSpeed);
  analogWrite(ENB, carSpeed);
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void turnRight(){
  analogWrite(ENA, 180);
  analogWrite(ENB, 180);
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);  digitalWrite(IN4, HIGH);
}

void turnLeft(){
  analogWrite(ENA, 180);
  analogWrite(ENB, 180);
  digitalWrite(IN1, LOW);  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

// ===== ุญุณุงุณ ุงูุงูุชุฑุงุณููู =====
long getDistanceCM(){
  digitalWrite(Trig, LOW); delayMicroseconds(2);
  digitalWrite(Trig, HIGH); delayMicroseconds(10);
  digitalWrite(Trig, LOW);
  unsigned long du = pulseIn(Echo, HIGH, 30000UL);
  if (du == 0) return 400;
  return (long)(du * 0.0343 / 2.0);
}

// ูุฑุงุกุฉ ูุณุงูุฉ ุนูุฏ ุฒุงููุฉ ูุนููุฉ
long senseAt(int angle){
  myservo.write(angle);
  delay(scanDelayMs);
  return getDistanceCM();
}

// ===== ุงูุฅุนุฏุงุฏ =====
void setup(){
  Serial.begin(9600);
  pinMode(Trig, OUTPUT);
  pinMode(Echo, INPUT);
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);
  pinMode(ENA, OUTPUT);
  pinMode(ENB, OUTPUT);

  myservo.attach(A0, 700, 2400);
  stopAll();
  myservo.write(centerAngle);
  delay(300);

  Serial.println("๐ค Human Follow Mode (smooth, 30โ50 cm range)");
}

// ===== ุงูุญููุฉ ุงูุฑุฆูุณูุฉ =====
void loop(){
  // ููุงุณ ุงููุณุงูุฉ ููุฃูุงู
  long dFront = senseAt(centerAngle);

  // ูู ุงููุฏู ุจุนูุฏ ุฌุฏูุง โ ุจุญุซ ุจุณูุท ูููู
  if (dFront >= farLimitCM){
    stopAll();
    turnRight(); delay(300);
    stopAll();   delay(100);
    return;
  }

  // ูู ูุฑูุจ ุฌุฏูุง (ุฃูู ูู 10 ุณู) โ ุฑุฌูุน ุฎููู
  if (dFront > 0 && dFront < backLimitCM){
    stopAll(); delay(60);
    back();    delay(backMs);
    stopAll(); delay(100);
    return;
  }

  // ูุณุญ ุฌุงูุจู ููุนุฑูุฉ ุงูุงุชุฌุงู ุงูุฃูุฑุจ
  long dRight = senseAt(rightAngle);
  myservo.write(centerAngle); delay(120);
  long dLeft  = senseAt(leftAngle);
  myservo.write(centerAngle); delay(120);

  // ุงุฎุชูุงุฑ ุฃูุตุฑ ูุณุงูุฉ (ูุนูู ุงูุฅูุณุงู)
  int bestAngle = centerAngle;
  long bestDist = dFront;

  if (dRight > 5 && dRight < bestDist) { bestDist = dRight; bestAngle = rightAngle; }
  if (dLeft  > 5 && dLeft  < bestDist) { bestDist = dLeft;  bestAngle = leftAngle;  }

  Serial.print("front="); Serial.print(dFront);
  Serial.print("  right="); Serial.print(dRight);
  Serial.print("  left=");  Serial.print(dLeft);
  Serial.print("  -> best "); Serial.print(bestAngle);
  Serial.print(" dist "); Serial.println(bestDist);

  // ุชูุฌูู ูุงุนู
  if (bestAngle == rightAngle){
    turnRight(); delay(turnMs);
    stopAll();   delay(80);
  } else if (bestAngle == leftAngle){
    turnLeft();  delay(turnMs);
    stopAll();   delay(80);
  }

  // ุชุชุจูุน ุณูุณ ุญุณุจ ุงููุณุงูุฉ
  if (bestDist > maxFollowCM){
    // ุงููุฏู ุจุนูุฏ โ ุชูุฏูู ุจุณูุงุณุฉ
    forward(); delay(fwdMs);
    stopAll(); delay(60);
  } 
  else if (bestDist < minFollowCM && bestDist > backLimitCM){
    // ูุฑูุจ ุฃูุชุฑ ูู 30 ุณู โ ุชุฑุงุฌุน ุจุณูุท
    back(); delay(backMs / 2);
    stopAll(); delay(60);
  } 
  else {
    // ุจูู 30โ50 ุณู โ ูุณุงูุฉ ูุซุงููุฉ
    stopAll(); delay(80);
  }
}
